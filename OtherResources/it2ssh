#!/usr/bin/env bash

set -euo pipefail

if [ "$#" -eq 0 ]; then
    ssh 2>&1 | sed -e 's/usage: ssh/usage: it2ssh/' >&2
    exit 1
fi

function print_osc() {
    if [[ $TERM == screen* ]]; then
        printf "\033Ptmux;\033\033]"
    else
        printf "\033]"
    fi
}

# More of the tmux workaround described above.
function print_st() {
    if [[ $TERM == screen* ]]; then
        printf "\a\033\\"
    else
        printf "\a"
    fi
}

mkdir -p ~/.ssh/controlmasters
CONTROL_PATH="$HOME/.ssh/controlmasters/%r@%h:%p"

if command -v base64 > /dev/null 2> /dev/null; then
    base64_encode() { command base64 | command tr -d \\n\\r; }
    base64_decode() { command base64 -d; }
elif command -v b64encode > /dev/null 2> /dev/null; then
    base64_encode() { command b64encode - | command sed '1d;$d' | command tr -d \\n\\r; }
    base64_decode() { command fold -w 76 | command b64decode -r; }
elif detect_python; then
    pybase64() { command "$python" -c "import sys, base64; getattr(sys.stdout, 'buffer', sys.stdout).write(base64.standard_b64$1(getattr(sys.stdin, 'buffer', sys.stdin).read()))"; }
    base64_encode() { pybase64 "encode"; }
    base64_decode() { pybase64 "decode"; }
elif detect_perl; then
    base64_encode() { command "$perl" -MMIME::Base64 -0777 -ne 'print encode_base64($_)'; }
    base64_decode() { command "$perl" -MMIME::Base64 -ne 'print decode_base64($_)'; }
else
    die "base64 executable not present on local host"
fi

conductor="c2V0IC1ldW8gcGlwZWZhaWwKbG9naW5fc2hlbGw9IiIKc2hlbGxfbmFtZT0iIgpxdWl0PTAKcHl0aG9uX2RldGVjdGVkPSIwIgpwZXJsX2RldGVjdGVkPSIwIgpleGVjX3NoZWxsPTAKcnVuX2NtZD0wCnJ1bl9weXRob249MApzdHR5X3NldHRpbmdzPSQoY29tbWFuZCBzdHR5IC1nKQpjbGVhbnVwKCkgewogIGNvbW1hbmQgc3R0eSAiJHN0dHlfc2V0dGluZ3MiCn0KZGllKCkgewogICAgbG9nIGRpZSAiJCoiCiAgICBwcmludGYgIlwwMzNbMzFtJXNcMDMzW21cblxyIiAiJCoiID4gL2Rldi9zdGRlcnIKICAgIGNsZWFudXAKICAgIGV4aXQgMQp9Cml0MnNzaF92ZXJib3NlPTAKbG9nKCkgewogICAgaWYgW1sgJGl0MnNzaF92ZXJib3NlID09IDAgXV07IHRoZW4KICAgICAgICByZXR1cm4KICAgIGZpCiAgICBwcmludGYgIlskJF0gJXM6ICVzXG4iICQoZGF0ZSArJUg6JU06JVMpICIkKiIgPj4gL3RtcC9pdDJzc2gubG9nCn0KcHJpbnRfZGNzKCkgewogICAgbG9jYWwgdG9rZW49JDEKICAgIGxvY2FsIHVuaXF1ZWlkPSQyCiAgICBsb2NhbCBib29sYXJncz0kMwogICAgbG9jYWwgc3NoYXJncz0kNAogICAgbG9nIG9zYyBwcmludF9kY3MgJDEgJDIgJDMgJDQKICAgIHByaW50ZiAiXDAzM1AyMDAwcCIKICAgIHByaW50ZiAiJXMgJXMgJXMgLSAlc1xuIiAiJHt0b2tlbn0iICIke3VuaXF1ZWlkfSIgIiR7Ym9vbGFyZ3N9IiAiJHtzc2hhcmdzfSIKfQpmaXJzdF93b3JkKCkgewogICAgbG9jYWwgaW5wdXQ9IiQxIgogICAgcHJpbnRmICIlcyIgJHtpbnB1dCUlICp9Cn0KZHJvcF9maXJzdF93b3JkKCkgewogICAgbG9jYWwgaW5wdXQ9IiQxIgogICAgbG9nIGRyb3AgZmlyc3Qgd29yZCBmcm9tOiAiJGlucHV0IgogICAgcHJpbnRmICIlcyIgIiR7aW5wdXQjKiB9Igp9CmlmIGNvbW1hbmQgLXYgYmFzZTY0ID4gL2Rldi9udWxsIDI+IC9kZXYvbnVsbDsgdGhlbgogICAgbG9nICJmb3VuZCBiYXNlNjQgY29tbWFuZCIKICAgIGJhc2U2NF9lbmNvZGUoKSB7IGNvbW1hbmQgYmFzZTY0IHwgY29tbWFuZCB0ciAtZCBcXG5cXHI7IH0KICAgIGJhc2U2NF9kZWNvZGUoKSB7IGNvbW1hbmQgYmFzZTY0IC1kOyB9CmVsaWYgY29tbWFuZCAtdiBiNjRlbmNvZGUgPiAvZGV2L251bGwgMj4gL2Rldi9udWxsOyB0aGVuCiAgICBsb2cgImZvdW5kIGI2NGVuY29kZSwgYjY0ZGVjb2RlIGNvbW1hbmRzIgogICAgYmFzZTY0X2VuY29kZSgpIHsgY29tbWFuZCBiNjRlbmNvZGUgLSB8IGNvbW1hbmQgc2VkICcxZDskZCcgfCBjb21tYW5kIHRyIC1kIFxcblxccjsgfQogICAgYmFzZTY0X2RlY29kZSgpIHsgY29tbWFuZCBmb2xkIC13IDc2IHwgY29tbWFuZCBiNjRkZWNvZGUgLXI7IH0KZWxpZiBkZXRlY3RfcHl0aG9uOyB0aGVuCiAgICBsb2cgInVzaW5nIHB5dGhvbiBmb3IgYmFzZTY0IgogICAgcHliYXNlNjQoKSB7IGNvbW1hbmQgIiRweXRob24iIC1jICJpbXBvcnQgc3lzLCBiYXNlNjQ7IGdldGF0dHIoc3lzLnN0ZG91dCwgJ2J1ZmZlcicsIHN5cy5zdGRvdXQpLndyaXRlKGJhc2U2NC5zdGFuZGFyZF9iNjQkMShnZXRhdHRyKHN5cy5zdGRpbiwgJ2J1ZmZlcicsIHN5cy5zdGRpbikucmVhZCgpKSkiOyB9CiAgICBiYXNlNjRfZW5jb2RlKCkgeyBweWJhc2U2NCAiZW5jb2RlIjsgfQogICAgYmFzZTY0X2RlY29kZSgpIHsgcHliYXNlNjQgImRlY29kZSI7IH0KZWxpZiBkZXRlY3RfcGVybDsgdGhlbgogICAgbG9nICJ1c2luZyBwZXJsIGZvciBiYXNlNjQiCiAgICBiYXNlNjRfZW5jb2RlKCkgeyBjb21tYW5kICIkcGVybCIgLU1NSU1FOjpCYXNlNjQgLTA3NzcgLW5lICdwcmludCBlbmNvZGVfYmFzZTY0KCRfKSc7IH0KICAgIGJhc2U2NF9kZWNvZGUoKSB7IGNvbW1hbmQgIiRwZXJsIiAtTU1JTUU6OkJhc2U2NCAtbmUgJ3ByaW50IGRlY29kZV9iYXNlNjQoJF8pJzsgfQplbHNlCiAgICBkaWUgImJhc2U2NCBleGVjdXRhYmxlIG5vdCBwcmVzZW50IG9uIHJlbW90ZSBob3N0IgpmaQpwYXJzZV9wYXNzd2RfcmVjb3JkKCkgewogICAgcHJpbnRmICIlcyIgIiQoY29tbWFuZCBncmVwIC1vICdbXjpdKiQnKSIKfQpsb2dpbl9zaGVsbF9pc19vaygpIHsKICAgIGxvZyBsb2dpbl9zaGVsbF9pc19vawogICAgWyAtbiAiJDEiIF0gJiYgbG9naW5fc2hlbGw9JChlY2hvICQxIHwgcGFyc2VfcGFzc3dkX3JlY29yZCkKICAgIFsgLW4gIiRsb2dpbl9zaGVsbCIgLWEgLXggIiRsb2dpbl9zaGVsbCIgXSAmJiByZXR1cm4gMAogICAgbG9nICJsb2dpbiBzaGVsbCBvZiAkbG9naW5fc2hlbGwgaXMgb2siCiAgICByZXR1cm4gMQp9CnVzaW5nX2dldGVudCgpIHsKICAgIGNtZD0kKGNvbW1hbmQgLXYgZ2V0ZW50KSAmJiBbIC1uICIkY21kIiBdICYmIG91dHB1dD0kKGNvbW1hbmQgIiRjbWQiIHBhc3N3ZCAiJFVTRVIiIDI+L2Rldi9udWxsKSBcCiAgICAmJiBsb2dpbl9zaGVsbF9pc19vayAiJG91dHB1dCIKfQp1c2luZ19pZCgpIHsKICAgIGNtZD0kKGNvbW1hbmQgLXYgaWQpICYmIFsgLW4gIiRjbWQiIF0gJiYgb3V0cHV0PSQoY29tbWFuZCAiJGNtZCIgLVAgIiRVU0VSIiAyPi9kZXYvbnVsbCkgXAogICAgJiYgbG9naW5fc2hlbGxfaXNfb2sgIiRvdXRwdXQiCn0KZGV0ZWN0X3B5dGhvbigpIHsKICAgIGlmIFsgcHl0aG9uX2RldGVjdGVkID0gIjEiIF07IHRoZW4KICAgICAgICBbIC1uICIkcHl0aG9uIiBdICYmIHJldHVybiAwCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCiAgICBweXRob25fZGV0ZWN0ZWQ9IjEiCiAgICBweXRob249JChjb21tYW5kIC12IHB5dGhvbjMpCiAgICBbIC16ICIkcHl0aG9uIiBdICYmIHB5dGhvbj0kKGNvbW1hbmQgLXYgcHl0aG9uMikKICAgIFsgLXogIiRweXRob24iIF0gJiYgcHl0aG9uPSQoY29tbWFuZCAtdiBweXRob24pCiAgICBpZiBbIC16ICIkcHl0aG9uIiAtbyAhIC14ICIkcHl0aG9uIiBdOyB0aGVuIHB5dGhvbj0iIjsgcmV0dXJuIDE7IGZpCiAgICBsb2cgbm8gcHl0aG9uCiAgICByZXR1cm4gMAp9CnVzaW5nX3B5dGhvbigpIHsKICAgIGRldGVjdF9weXRob24gJiYgb3V0cHV0PSQoY29tbWFuZCAiJHB5dGhvbiIgLWMgImltcG9ydCBwd2QsIG9zOyBwcmludChwd2QuZ2V0cHd1aWQob3MuZ2V0ZXVpZCgpKS5wd19zaGVsbCkiKSBcCiAgICAmJiBsb2dpbl9zaGVsbD0iJG91dHB1dCIgJiYgbG9naW5fc2hlbGxfaXNfb2sKfQpkZXRlY3RfcGVybCgpIHsKICAgIGlmIFsgcGVybF9kZXRlY3RlZCA9ICIxIiBdOyB0aGVuCiAgICAgICAgWyAtbiAiJHBlcmwiIF0gJiYgcmV0dXJuIDAKICAgICAgICByZXR1cm4gMQogICAgZmkKICAgIHBlcmxfZGV0ZWN0ZWQ9IjEiCiAgICBwZXJsPSQoY29tbWFuZCAtdiBwZXJsKQogICAgaWYgWyAteiAiJHBlcmwiIC1vICEgLXggIiRwZXJsIiBdOyB0aGVuIHBlcmw9IiI7IHJldHVybiAxOyBmaQogICAgbG9nIG5vIHBlcmwKICAgIHJldHVybiAwCn0KdXNpbmdfcGVybCgpIHsKICAgIGRldGVjdF9wZXJsICYmIG91dHB1dD0kKGNvbW1hbmQgIiRwZXJsIiAtZSAnbXkgJHNoZWxsID0gKGdldHB3dWlkKCQ8KSlbOF07IHByaW50ICRzaGVsbCcpIFwKICAgICYmIGxvZ2luX3NoZWxsPSIkb3V0cHV0IiAmJiBsb2dpbl9zaGVsbF9pc19vawp9CnVzaW5nX3NoZWxsX2VudigpIHsKICAgIFsgLW4gIiRTSEVMTCIgXSAmJiBsb2dpbl9zaGVsbD0iJFNIRUxMIiAmJiBsb2dpbl9zaGVsbF9pc19vawp9Cmd1ZXNzX2xvZ2luX3NoZWxsKCkgewogICAgWyAtbiAiJGxvZ2luX3NoZWxsIiBdIHx8IHVzaW5nX2dldGVudCB8fCB1c2luZ19pZCB8fCB1c2luZ19weXRob24gfHwgdXNpbmdfcGVybCB8fCB1c2luZ19wYXNzd2QgfHwgdXNpbmdfc2hlbGxfZW52IHx8IGxvZ2luX3NoZWxsPSJzaCIKICAgIHNoZWxsX25hbWU9JChjb21tYW5kIGJhc2VuYW1lICRsb2dpbl9zaGVsbCkKICAgIGxvZyBsb2dpbiBzaGVsbCBpcyAke3NoZWxsX25hbWV9CiAgICBwcmludGYgIiVzIiAke3NoZWxsX25hbWV9Cn0KZXhlY3V0ZV93aXRoX3BlcmwoKSB7CiAgICBpZiBkZXRlY3RfcGVybDsgdGhlbgogICAgICAgIGxvZyBleGVjdXRlIGxvZ2luIHNoZWxsIHVzaW5nIHBlcmwKICAgICAgICBleGVjICIkcGVybCIgIi1lIiAiZXhlYyB7JyRsb2dpbl9zaGVsbCd9ICctJHNoZWxsX25hbWUnIgogICAgZmkKICAgIHJldHVybiAxCn0KZXhlY3V0ZV93aXRoX3B5dGhvbigpIHsKICAgIGlmIGRldGVjdF9weXRob247IHRoZW4KICAgICAgICBsb2cgZXhlY3V0ZSBsb2dpbiBzaGVsbCB1c2luZyBweXRob24KICAgICAgICBleGVjICIkcGVybCIgIi1lIiAiZXhlYyB7JyRsb2dpbl9zaGVsbCd9ICctJHNoZWxsX25hbWUnIgogICAgICAgIGV4ZWMgIiRweXRob24iICItYyIgImltcG9ydCBvczsgb3MuZXhlY2xwKCckbG9naW5fc2hlbGwnLCAnLScgJyRzaGVsbF9uYW1lJykiCiAgICBmaQogICAgcmV0dXJuIDEKfQpleGVjX2xvZ2luX3NoZWxsKCkgewogICAgbG9jYWwgbG9naW5fc2hlbGw9JHsxfQogICAgbG9nIGV4ZWNfbG9naW5fc2hlbGwgIiRsb2dpbl9zaGVsbCIKICAgIFsgIiQoZXhlYyAtYSBlY2hvIGVjaG8gT0sgMj4gL2Rldi9udWxsKSIgPSAiT0siIF0gJiYgZXhlYyAtYSAiLSRzaGVsbF9uYW1lIiAiJGxvZ2luX3NoZWxsIgogICAgbG9nIGZhaWxlZCwgdHJ5IHB5dGhvbgogICAgZXhlY3V0ZV93aXRoX3B5dGhvbgogICAgbG9nIGZhaWxlZCwgdHJ5IHBlcmwKICAgIGV4ZWN1dGVfd2l0aF9wZXJsCiAgICBsb2cgZmFpbGVkLCBqdXN0IHJ1biBpdCB3aXRoIC1sCiAgICBleGVjICIkbG9naW5fc2hlbGwiICItbCIKICAgIGxvZyBmYWlsZWQgY29tcGxldGVseQogICAgcHJpbnRmICIlc1xuIiAiQ291bGQgbm90IGV4ZWN1dGUgdGhlIHNoZWxsICRsb2dpbl9zaGVsbCBhcyBhIGxvZ2luIHNoZWxsIiA+IC9kZXYvc3RkZXJyCiAgICBleGVjICIkbG9naW5fc2hlbGwiCn0KY29uZHVjdG9yX2NtZF9leGVjX2xvZ2luX3NoZWxsKCkgewogICAgbG9nIGNvbmR1Y3Rvcl9jbWRfZXhlY19sb2dpbl9zaGVsbAogICAgZXhlY19zaGVsbD0xCn0KcmVhbGx5X2V4ZWNfbG9naW5fc2hlbGwoKSB7CiAgICBleGVjX2xvZ2luX3NoZWxsICQoZ3Vlc3NfbG9naW5fc2hlbGwpCn0KY29uZHVjdG9yX2NtZF9zZXRlbnYoKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF9zZXRlbnYKICAgIGlmIFsgIiQjIiAtbmUgMiBdOyB0aGVuCiAgICAgICAgbG9nIGJhZCBhcmdzCiAgICAgICAgKGV4aXQgMSkKICAgICAgICByZXR1cm4KICAgIGZpCiAgICBsb2NhbCBuYW1lPSQxCiAgICBsb2NhbCB2YWx1ZT0kMgogICAgbG9nIHNldGVudiAke25hbWV9PSR7dmFsdWV9CiAgICBleHBvcnQgJHtuYW1lfT0ke3ZhbHVlfQp9CmNvbmR1Y3Rvcl9jbWRfcnVuKCkgewogICAgbG9nIGNvbmR1Y3Rvcl9jbWRfcnVuCiAgICBydW5fY21kPTEKfQpjb25kdWN0b3JfY21kX3J1bnB5dGhvbigpIHsKICAgIGxvZyBjb25kdWN0b3JfY21kX3J1bnB5dGhvbgogICAgcnVuX3B5dGhvbj0xCn0KcmVhbGx5X3J1bl9weXRob24oKSB7CiAgcmNlPScKaW1wb3J0IG9zCmltcG9ydCBzeXMKdHR5X3BhdGggPSBvcy50dHluYW1lKHN5cy5zdGRvdXQuZmlsZW5vKCkpCnN5cy5zdGRpbiA9IG9wZW4odHR5X3BhdGgsICJyIikKdHJ5OgogIHByaW50KGYiXDAzM10xMzU7Ontvcy5nZXRwaWQoKX1cMDMzXFxcMDMzXTEzNTs6ZW5kICciJGJvdW5kYXJ5IicgciAwXDAzM1xcIiwgZW5kPSIiLCBmbHVzaD1UcnVlKQogIHByb2dyYW09IiIKICBmb3IgbGluZSBpbiBzeXMuc3RkaW46CiAgICBpZiBsaW5lLnJzdHJpcCgpID09ICJFT0YiOgogICAgICBleGVjKHByb2dyYW0pCiAgICAgIHByaW50KGYiXDAzM10xMzU7OnVuaG9va1wwMzNcXCIsIGVuZD0iIiwgZmx1c2g9VHJ1ZSkKICAgICAgYnJlYWsKICAgIHByb2dyYW0gKz0gbGluZQpleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgcHJpbnQoZSkKJwogIGV4ZWMgcHl0aG9uMyA8PDwgIiRyY2UiCiAgbG9nICJ1bmV4cGVjdGVkIHJldHVybiBmcm9tIGV4ZWMiCiAgZXhpdCAwCn0KcmVhbGx5X3J1bigpIHsKICAgIGxvZyByZWFsbHlfcnVuCiAgICBpZiBbICIkIyIgLWx0IDEgXTsgdGhlbgogICAgICAgIGxvZyBiYWQgYXJncwogICAgICAgIChleGl0IDEpCiAgICAgICAgcmV0dXJuCiAgICBmaQogICAgbG9nIGV4ZWMgIiRTSEVMTCIgLWMgIiQqIgogICAgcHJpbnRmICJcZV0xMzU7OiIKICAgIGV4ZWMgIiRTSEVMTCIgLWMgIiQqIgogICAgcHJpbnRmICJcZVxcIgp9CmNvbmR1Y3Rvcl9jbWRfc2hlbGwoKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF9zaGVsbAogICAgaWYgWyAiJCMiIC1sdCAyIF07IHRoZW4KICAgICAgICBsb2cgYmFkIGFyZ3MKICAgICAgICAoZXhpdCAxKQogICAgICAgIHJldHVybgogICAgZmkKICAgIHByaW50ZiAiXGVdMTM1OzoiCiAgICBzZXQgK2UKICAgIHNldCArbyBwaXBlZmFpbAogICAgJCoKICAgIHByaW50ZiAiXGVcXCIKfQpjb25kdWN0b3JfY21kX3dyaXRlKCkgewogICAgbG9nIGNvbmR1Y3Rvcl9jbWRfd3JpdGUKICAgIGxvZyBoYXZlICQjIGFyZ3VtZW50cwogICAgaWYgWyAiJCMiIC1uZSAyIF07IHRoZW4KICAgICAgICBsb2cgYmFkIGFyZ3MKICAgICAgICAoZXhpdCAxKQogICAgICAgIHJldHVybgogICAgZmkKICAgIGxvZyB3aWxsIHdyaXRlIHRvICIkMiIKICAgIGxvY2FsIGI2NGRhdGE9JDEKICAgIGxvY2FsIGRlc3RpbmF0aW9uPSQoZXZhbCBwcmludGYgJXMgIiQyIikKICAgIGxvZyB3cml0aW5nIHRvICRkZXN0aW5hdGlvbiBiYXNlZCBvbiAkMgogICAgb2xkX3VtYXNrPSQodW1hc2spCiAgICB1bWFzayAwMDAKICAgIHByaW50ZiAiJXMiICR7YjY0ZGF0YX0gfCBiYXNlNjRfZGVjb2RlIHwgY29tbWFuZCB0YXIgInhwemYiICItIiAiLUMiICIkZGVzdGluYXRpb24iCiAgICBsb2NhbCByYz0kPwogICAgdW1hc2sgIiRvbGRfdW1hc2siCiAgICAoZXhpdCAkcmMpCn0KY29uZHVjdG9yX2NtZF9jZCgpIHsKICAgIGxvZyBjZAogICAgaWYgWyAiJCMiIC1uZSAxIF07IHRoZW4KICAgICAgICBsb2cgImJhZCBhcmdzIgogICAgICAgIChleGl0IDEpCiAgICAgICAgcmV0dXJuCiAgICBmaQogICAgbG9jYWwgZGlyPSQxCiAgICBsb2cgY2QgJGRpcgogICAgY2QgIiRkaXIiID4gL2Rldi9udWxsIDI+JjEKfQpjb25kdWN0b3JfY21kX3F1aXQoKSB7CiAgICBsb2cgcXVpdAogICAgcXVpdD0xCn0Kd3JpdGUoKSB7CiAgICBwcmludGYgIlxlXTEzNTs6JXNcZVxcIiAiJCoiCn0KaGFuZGxlX2NvbW1hbmQoKSB7CiAgICBsb2NhbCB1bnBhcnNlZD0kezF9CiAgICBsb2cgaGFuZGxlX2NvbW1hbmQgJHVucGFyc2VkCiAgICBsb2NhbCBjbWRfbmFtZT0kKGZpcnN0X3dvcmQgIiR7dW5wYXJzZWR9IikKICAgIGxvZyBjbWRfbmFtZSBpcyAkY21kX25hbWUKICAgIGxvY2FsIGFyZ3M9JChkcm9wX2ZpcnN0X3dvcmQgIiR7dW5wYXJzZWR9IikKICAgIGxvZyBhcmdzIGlzICRhcmdzCiAgICBsb2NhbCBib3VuZGFyeT0iJHtSQU5ET019JHtSQU5ET019JHtSQU5ET019JHtSQU5ET019IgogICAgd3JpdGUgYmVnaW4gJGJvdW5kYXJ5CiAgICBsb2cgaW52b2tlICRjbWRfbmFtZSB3aXRoIGFyZ3VtZW50cyAkYXJncwogICAgc2V0ICtlCiAgICBzZXQgK28gcGlwZWZhaWwKICAgIGlmIFtbICQodHlwZSAtdCBjb25kdWN0b3JfY21kXyR7Y21kX25hbWV9KSA9PSBmdW5jdGlvbiBdXTsgdGhlbgogICAgICAgIGNvbmR1Y3Rvcl9jbWRfJHtjbWRfbmFtZX0gJGFyZ3MKICAgIGVsc2UKICAgICAgICB3cml0ZSAiYmFkIGNvbW1hbmQgJHtjbWRfbmFtZX0iCiAgICAgICAgZmFsc2UKICAgIGZpCiAgICBpZiBbWyAkcnVuX3B5dGhvbiA9PSAxIF1dOyB0aGVuCiAgICAgICAgcmVhbGx5X3J1bl9weXRob24gIiRib3VuZGFyeSIKICAgIGZpCiAgICB3cml0ZSBlbmQgJGJvdW5kYXJ5ICQ/IHIKICAgIGlmIFtbICRxdWl0ID09IDEgXV07IHRoZW4KICAgICAgICBleGl0IDAKICAgIGZpCiAgICBpZiBbWyAkZXhlY19zaGVsbCA9PSAxIF1dOyB0aGVuCiAgICAgICAgd3JpdGUgdW5ob29rCiAgICAgICAgY2xlYW51cAogICAgICAgIHJlYWxseV9leGVjX2xvZ2luX3NoZWxsCiAgICBmaQogICAgaWYgW1sgJHJ1bl9jbWQgPT0gMSBdXTsgdGhlbgogICAgICAgIHdyaXRlIHVuaG9vawogICAgICAgIGNsZWFudXAKICAgICAgICByZWFsbHlfcnVuICRhcmdzCiAgICBmaQogICAgc2V0IC1lCiAgICBzZXQgLW8gcGlwZWZhaWwKfQppdGVyYXRlKCkgewogICAgbG9nIGl0ZXJhdGUKICAgIGxpbmU9IiIKICAgIHdoaWxlIHRydWU7IGRvCiAgICAgICAgcmVhZCBwYXJ0CiAgICAgICAgbG9nIHJlYWQgcGFydCAiJHBhcnQiCiAgICAgICAgaWYgWyAteiAiJHBhcnQiIF07IHRoZW4KICAgICAgICAgICAgYnJlYWsKICAgICAgICBmaQogICAgICAgIGxpbmU9IiR7bGluZX0ke3BhcnR9IgogICAgZG9uZQogICAgbG9nIHJlYWQgbGluZSAiJGxpbmUiCiAgICBoYW5kbGVfY29tbWFuZCAiJGxpbmUiCn0KZHJhaW5fc3RkaW4oKSB7CiAgbG9nIGRyYWluX3N0ZGluCiAgc3R0eSAtZWNobyAtaWNhbm9uIHRpbWUgMCBtaW4gMAogIHdoaWxlIDoKICBkbwogICAgICBrZXk9IiQocHJpbnRmIHg7IGRkIGJzPTEgY291bnQ9MSAyPiAvZGV2L251bGw7IHByaW50ZiB4KSIKICAgICAgaWYgW1sgIiRrZXkiID09ICJ4eCIgXV07IHRoZW4KICAgICAgICAgIGxvZyAiZG9uZSBkcmFpbmluZyIKICAgICAgICAgIGJyZWFrCiAgICAgIGZpCiAgICAgIGxvZyAiJGtleSIKICBkb25lCiAgY2xlYW51cAp9Cm1haW4oKSB7CiAgICBsb2NhbCB0b2tlbj0iJDEiCiAgICBsb2NhbCB1bmlxdWVpZD0iJDIiCiAgICBsb2NhbCBib29sZWFuYXJncz0iJDMiCiAgICBsb2NhbCBzc2hhcmdzPSIkNCIKICAgIGxvZyBzdGFydGluZyB3aXRoIHRva2VuICR0b2tlbgogICAgbG9nICQoZW52KQogICAgdHJhcCAiY2xlYW51cCIgRVhJVAogICAgZHJhaW5fc3RkaW4KICAgIHN0dHkgLWVjaG8gLW9ubGNyIC1vcG9zdAogICAgcHJpbnRfZGNzICIkdG9rZW4iICIkdW5pcXVlaWQiICIkYm9vbGVhbmFyZ3MiICIkc3NoYXJncyIKICAgIGxvZyBiZWdpbiBtYWlubG9vcAogICAgd2hpbGUgdHJ1ZTsgZG8KICAgICAgICBpdGVyYXRlCiAgICBkb25lCn0K"

# Trying to escape this broke me.
eval_cmd=$(printf %s "J2V2YWwgIiQoZWNobyAiJDAiIHwgdHIgXFxcdlxcXGZcXFxyXFxcYiBcXFwwNDdcXFwxMzRcXFxuXFxcMDQxKSInIA==" | base64_decode)

sanitized="$(printf %s "$conductor" | base64_decode | tr "\!'\n\\" \\b\\v\\r\\f)"

SSH=/usr/bin/ssh
if [[ "$OSTYPE" == "darwin"* ]]; then
  TOKEN=""
  for SOCKET in ~/.config/iterm2/sockets/secrets ~/.iterm2/sockets/secrets ~/.iterm2-1/sockets/secrets
  do
      [ -z "$TOKEN" ] && TOKEN=$(nc -U $SOCKET || true)
  done
else
  TOKEN="none"
fi


if [ ! -d ~/.ssh ]; then
    mkdir ~/.ssh
    chmod 700 ~/.ssh
fi

print_osc
printf "1337;Env=report=all:"
command env | base64_encode
print_st

SSHARGS=$(printf %s "$*" | base64_encode)
UNIQUEID=${RANDOM}${RANDOM}

USER_ARGS=()
HOSTNAME=""
COMMAND=()
ARGS_ALLOWED=1
EXPECT_VALUE=0
BOOLEAN_ARGS=$(ssh 2>&1 | tr -d '\n' | sed -e 's/^[^[]*\[-*\([a-z0-9A-Z]*\).*/\1/' || true)
HAS_T=0

while [[ $# -gt 0 ]]; do
    if [[ $EXPECT_VALUE == 1 ]]; then
        USER_ARGS+=("$1")
        EXPECT_VALUE=0
    elif [[ $ARGS_ALLOWED == 0 ]]; then
        if [[ $HOSTNAME == "" ]]; then
            HOSTNAME="$1"
        else
            COMMAND+=("$1")
        fi
    else
        case $1 in
            -N|-n|-f|-G)
                echo "it2sh is meant for interactive use via SSH only and is not compatible with the $1 argument."
                exit 1
                ;;
            -t)
                HAS_T=1
                USER_ARGS+=("-t")
                ;;
            -*)
                LETTER="${1:1}"
                if (printf %s "$BOOLEAN_ARGS" | grep "$LETTER"  > /dev/null 2>&1)
                then
                    EXPECT_VALUE=0
                else
                    EXPECT_VALUE=1
                fi
                USER_ARGS+=("$1")
                ;;
            --)
                ARGS_ALLOWED=0
                ;;
            *)
                ARGS_ALLOWED=0
                HOSTNAME="$1"
                ;;
        esac
    fi
    shift
done

if [[ $HAS_T == 0 ]]; then
    USER_ARGS+=("-t")
fi

# Here we do /usr/bin/env sh rather than exec sh to avoid adding this command
# to the login shell's history.
ENCODED_BA=$(printf %s "$BOOLEAN_ARGS" | base64_encode)

# If ssh gets a signal, let it2ssh keep running.
set +e

$SSH \
"${USER_ARGS[@]}" \
-- \
"$HOSTNAME" \
exec \
sh \
-c \
"$eval_cmd" \
\'"$sanitized main $TOKEN ${UNIQUEID} $ENCODED_BA $SSHARGS"\'

print_osc
printf "1337;EndSSH=%s" "${UNIQUEID}"
print_st

